<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Adventures with the Thinkpad T440p, dGPU and Coreboot in "Mid 2022" | Crayblog</title>
<meta name=keywords content>
<meta name=description content="This is my documentation about the process of flashing and tweaking coreboot to run properly on my T440p with a dedicated NVIDIA GPU, colloquially known as a &lsquo;dGPU&rsquo;. There are multiple guides that will teach you how to build, flash, or build and flash coreboot on a T440p without issue. However, if you have a T440p with a dGPU, you will quickly realize that the GPU is mysteriously absent from your PCI device list.">
<meta name=author content="Crayphish">
<link rel=canonical href=https://crayphish.github.io/posts/t440p-adventures/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css integrity="sha256-7I2jZsovtkdTfMt6j2+ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://crayphish.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://crayphish.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://crayphish.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://crayphish.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://crayphish.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
</noscript><meta property="og:title" content="Adventures with the Thinkpad T440p, dGPU and Coreboot in &#34;Mid 2022&#34;">
<meta property="og:description" content="This is my documentation about the process of flashing and tweaking coreboot to run properly on my T440p with a dedicated NVIDIA GPU, colloquially known as a &lsquo;dGPU&rsquo;. There are multiple guides that will teach you how to build, flash, or build and flash coreboot on a T440p without issue. However, if you have a T440p with a dGPU, you will quickly realize that the GPU is mysteriously absent from your PCI device list.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://crayphish.github.io/posts/t440p-adventures/"><meta property="og:image" content="https://crayphish.github.io/papermod-cover.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-05-21T17:11:41+12:00">
<meta property="article:modified_time" content="2022-05-21T17:11:41+12:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://crayphish.github.io/papermod-cover.png">
<meta name=twitter:title content="Adventures with the Thinkpad T440p, dGPU and Coreboot in &#34;Mid 2022&#34;">
<meta name=twitter:description content="This is my documentation about the process of flashing and tweaking coreboot to run properly on my T440p with a dedicated NVIDIA GPU, colloquially known as a &lsquo;dGPU&rsquo;. There are multiple guides that will teach you how to build, flash, or build and flash coreboot on a T440p without issue. However, if you have a T440p with a dGPU, you will quickly realize that the GPU is mysteriously absent from your PCI device list.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://crayphish.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Adventures with the Thinkpad T440p, dGPU and Coreboot in \"Mid 2022\"","item":"https://crayphish.github.io/posts/t440p-adventures/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Adventures with the Thinkpad T440p, dGPU and Coreboot in \"Mid 2022\"","name":"Adventures with the Thinkpad T440p, dGPU and Coreboot in \u0022Mid 2022\u0022","description":"This is my documentation about the process of flashing and tweaking coreboot to run properly on my T440p with a dedicated NVIDIA GPU, colloquially known as a \u0026lsquo;dGPU\u0026rsquo;. There are multiple guides that will teach you how to build, flash, or build and flash coreboot on a T440p without issue. However, if you have a T440p with a dGPU, you will quickly realize that the GPU is mysteriously absent from your PCI device list.","keywords":[],"articleBody":"This is my documentation about the process of flashing and tweaking coreboot to run properly on my T440p with a dedicated NVIDIA GPU, colloquially known as a ‘dGPU’. There are multiple guides that will teach you how to build, flash, or build and flash coreboot on a T440p without issue. However, if you have a T440p with a dGPU, you will quickly realize that the GPU is mysteriously absent from your PCI device list. Information about why or how to enable this is scattered and often dated, so I’ve created this page to dump it all to. Hopefully other people who are in the same position can make use of it. This is assuming you are installing a GNU/Linux distro on your machine; I can’t speak to any of this working with Windows.\ntl;dr - You’re already familiar with coreboot but just want dGPU support The current coreboot code for the T440p has the PCI Express Graphics (PEG) device that handles the dGPU disabled. Thanks to nullenvk, you can restore dGPU functions by applying this commit, which adds the “Enable dedicated graphics (experimental)” option to nconfig. Enabling this will re-enable the PEG device in your next coreboot build. You need to include the VBIOS for both the iGPU and dGPU. You can extract both using VBiosFinder. If you’re building coreboot from master branch, the current SeaBIOS payload will result in a bootloop. Use SeaBIOS 1.15 or TianoCore (UEFI OS only).\nThe Long Version Intro The Thinkpad T440p is a 14\" laptop released in November 2013 by Lenovo. They’re tough, upgradable and plentiful on the used market. There are multiple writeups espousing their virtues and limitations.\nBack in December I managed to get a good deal on a second hand T440p. The listing was sparse and mostly listed the 4GB RAM and 4-core low power i5 CPU, but I could source upgrades for both. I got it home to find out it also had a locked BIOS and an NVIDIA dedicated GPU. I wasn’t counting on either of these but thankfully there neither would be a problem. As of November 2019, The T440p supports Coreboot, an open source firmware platform. There are multiple good guides that step through how to build (or give you an already built) coreboot and flash the whole thing for the first time. However, information on getting a dGPU working is scattered and outdated. It seems that, even when coreboot users have the dGPU on-board, they typically opt not to use it. The dGPU adds a lot of battery drain and heat to keep under control. The heatsink and fan on this unit handle both the CPU and GPU, and if one was focussing on CPU performance thanks to an upgrade, they would likely want to avoid the heat contest with the dGPU. To make matters more confusing, if one recently followed the instructions to manually build coreboot for themselves and chose to use the current SeaBIOS (1.16) payload, they’d get a bootloop.\nGiven that the dGPU is much higher power draw for questionable performance gains, it might seem somewhat redundant to try and get it going. However in my testing I’ve found the GT 730M to play older games at reasonable (720p) framerates. Additionally, the GT 730M has ‘complete’ Vulkan support, while the HD 4600 warns that the implementation is incomplete; the only example I have is that the iGPU cannot run Half-Life 2 via Proton/DXVK, but has no problem with the ToGL ‘native’ Linux port. The dGPU can do either, which opens up the possibility of running older or lower spec Windows games on the machine.\nBuilding Coreboot with dGPU Support Here’s the stuff that helped me the most:\n Skulls Pre-built Coreboot Images for T440p - Follow this guide to get a working, albeit slightly outdated coreboot install with a SeaBIOS 1.15 payload. Requires the least amount of steps for a working install imo. Conor Burns Excellent T440p Coreboot Flashing Guide - Following this will get you a working coreboot install with a Tianocore payload, which only supports booting UEFI OSes, however this guide takes you through manually building and flashing coreboot yourself, is fairly recent, and comes with a good base set of config parameters. Highly recommended.  These are both excellent, but unfortunately neither will yield a coreboot install with dedicated GPU support, since in coreboot itself the PCIe device that handles the dGPU is disabled by default. This helps iGPU only units, but is crucial for dGPU units to access the dGPU. Thanks to nullenvk figuring this out, there is a commit that will add the option to re-enable this PEG device in the coreboot configuration. You can apply this as a patch to a local copy of the coreboot repo. The whole process looks something like this:\ngit clone https://github.com/coreboot/coreboot cd coreboot curl https://github.com/nullenvk/coreboot/commit/aef930dcb6089ef21f00820b2af93654138e1f83.patch | git apply -v This will patch some files in the t440p section of the coreboot source, and then when running make nconfig, you will have the extra dGPU toggle. Thanks nullenvk!\nHere’s a summary of my steps:\n Followed Conor’s guide, up to Configuration section, but used the coreboot master branch instead of the suggested branch and did not downgrade gcc. Applied nullenvk’s changes as a patch to local coreboot repo - see above Extracted both VBIOS blobs from the t440p-original.rom made during the guide using VBiosFinder Continued Conor’s guide. During make nconfig, enabled dedicated graphics and added both VBIOS files. Draw the rest of the fucking owl (build coreboot)  At this point you can either split it as per the guide and do the first ever flash, or (in my case, since I already had a skulls image installed) flash coreboot from the OS… and Voila! The dGPU is… still not listed in lscpi or dmesg. The last step you will need to do is build nvramtool and use it to enable the “Dual Graphics” feature. Then after a reboot, you should have a working dGPU using the nouveau driver. Now you can enjoy the pain of configuring the nvidia proprietary driver alongside i915/mesa and getting it to meaningfully work and switch on your whim. Have fun! I put some of that down below if you’re still looking to punish yourself a little.\nOptimus PRIME You are now working with an NVIDIA Optimus environment, the name for their hybrid graphics solution that puts the dGPU behind the iGPU and creates all kinds of cursed power consumption, tearing, sync, Wayland/X11 issues, etc. This is a hardware-level implementation, so you unfortunately can’t magic it away with FOSS. You are spoilt for many (unsatisfactory) choices when picking a way of handling this. Here’s the Arch Wiki page that covers most of the options.\nFWIW I use EnvyControl. This tool will let you switch between pure iGPU with the dGPU disabled, full dGPU, and “Hybrid” mode, requiring a system reboot between each change. These all come with caveats, but I think I am happy with switching between iGPU only and Hybrid. This allows me to use Wayland most of the time since the iGPU will handle the Desktop Environment, passing OGL/Vulkan workloads to the dGPU on demand. Envycontrol will also handle the kernel parameter necessary for getting tear-free sync when the dGPU is running, which typically gets in the way of fully disabling the nvidia GPU in other solutions.\nOn an aside, what the fuck is NVIDIA doing with the tearing sync? If you don’t use the nvidia-drm.modeset=1 parameter when using the dGPU on it’s own, you get diagonal tearing. What the hell kinda order are they drawing the framebuffer?\nAnyway, some useful variables when operating in hybrid mode:\n __NV_PRIME_RENDER_OFFLOAD=1 __GLX_VENDOR_LIBRARY_NAME=nvidia __VK_LAYER_NV_optimus=NVIDIA_only will enable offload rendering and tell OpenGL and Vulkan programs to use the nvidia driver. An easy drop in solution is to put all of these variables in a script like below, and throw it in your $PATH somewhere, as per this askubuntu answer: https://askubuntu.com/a/1368463  #!/bin/bash export __NV_PRIME_RENDER_OFFLOAD=1 export __GLX_VENDOR_LIBRARY_NAME=nvidia export __VK_LAYER_NV_optimus=NVIDIA_only export VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/nvidia_icd.json exec \"$@\"  I’ve found Vulkan programs seem to correctly select the dGPU on their own since it shows up as Vulkan device 0 in hybrid mode for me. The above __VK_LAYER_NV_optimus=NVIDIA_only parameter should force this regardless. Most of the Vulkan programs will let you pick the Vulkan device via an argument/config file/menu/etc. If you are using Proton/DXVK, you can use the parameter DXVK_FILTER_DEVICE_NAME=\"GeForce GT 730M\" to force the dGPU or DXVK_FILTER_DEVICE_NAME=\"HD Graphics 4600\" to force the iGPU. Device names might need to be changed depending on model, and you can find them using vulkaninfo. This won’t work for native Vulkan games/programs since they don’t use DXVK.  Miscellaneous  Despite what I read online, you can use libgfxinit to boot as well as install both VBIOS blobs for the Intel and NVIDIA GPUs. The last NVIDIA driver the GT 730M supports is nvidia-470. These are available on the AUR as nvidia-470xx-dkms. If you use MangoHud, enable the vulkan_driver option and you will be able to identify which GPU the current software is running on based on which driver is providing Vulkan; “470…” for NVIDIA and “Mesa…” for Intel. When using Wayland in hybrid mode, whatever it’s enforcing on XWayland causes the dGPU to enforce Vsync even when manually disabled by other means. I can only get an uncapped framerate in 3d workloads on the dGPU by using X11. I might be overlooking something. Steam Big Picture warns against using the iGPU at 1080p due to the limited (256mb) of assigned RAM - VRAM. In hybrid mode, you can run steam itself with the above rendering offload commands to get Big Picture to use the dGPU (with it’s dedicated 1GB VRAM) and circumvent this issue. Steam Remote Play uses VAAPI regardless of which GPU you give it, and results in roughly the same ~14ms latency on either. Tested at 1080p to a desktop machine running Earth Defense Force 5. Very playable. I wouldn’t bother offloading remote game streaming to the dGPU. My specific touchpad stops responding correctly or entirely after suspend. This was fixed for me with the kernel parameter psmouse.synaptics_intertouch=0. YMMV depending on the touchpad make/model. Under coreboot on the T440p, The SD Card Reader doesn’t work.  That’s everything for now. I’ve tried to play a few older or lower spec games at 720p such as HL2, Portal and ULTRAKILL, all of which ran well enough. Over the next few weeks I will be trying other software to see if the additional acceleration is worth the time. I was thinking of benchmarking some things to compare using Mangohud, but the logging function appears to fail to write with certain game names. I may need to check my configuration.\n","wordCount":"1771","inLanguage":"en","datePublished":"2022-05-21T17:11:41+12:00","dateModified":"2022-05-21T17:11:41+12:00","author":{"@type":"Person","name":"Crayphish"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://crayphish.github.io/posts/t440p-adventures/"},"publisher":{"@type":"Organization","name":"Crayblog","logo":{"@type":"ImageObject","url":"https://crayphish.github.io/favicon.ico"}}}</script>
</head>
<body class=dark id=top>
<script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://crayphish.github.io/ accesskey=h title="Crayblog (Alt + H)">Crayblog</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://crayphish.github.io/archives title=Archive>
<span>Archive</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://crayphish.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://crayphish.github.io/posts/>Posts</a></div>
<h1 class=post-title>
Adventures with the Thinkpad T440p, dGPU and Coreboot in "Mid 2022"
</h1>
<div class=post-meta><span title="2022-05-21 17:11:41 +1200 +1200">May 21, 2022</span>&nbsp;·&nbsp;Crayphish
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#tldr---youre-already-familiar-with-coreboot-but-just-want-dgpu-support aria-label="tl;dr - You&amp;rsquo;re already familiar with coreboot but just want dGPU support">tl;dr - You&rsquo;re already familiar with coreboot but just want dGPU support</a></li>
<li>
<a href=#the-long-version aria-label="The Long Version">The Long Version</a><ul>
<li>
<a href=#intro aria-label=Intro>Intro</a></li>
<li>
<a href=#building-coreboot-with-dgpu-support aria-label="Building Coreboot with dGPU Support">Building Coreboot with dGPU Support</a></li>
<li>
<a href=#optimus-prime aria-label="Optimus PRIME">Optimus PRIME</a></li></ul>
</li>
<li>
<a href=#miscellaneous aria-label=Miscellaneous>Miscellaneous</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p><em>This is my documentation about the process of flashing and tweaking coreboot to run properly on my T440p with a dedicated NVIDIA GPU, colloquially known as a &lsquo;dGPU&rsquo;. There are multiple guides that will teach you how to build, flash, or build and flash coreboot on a T440p without issue. However, if you have a T440p with a dGPU, you will quickly realize that the GPU is mysteriously absent from your PCI device list. Information about why or how to enable this is scattered and often dated, so I&rsquo;ve created this page to dump it all to. Hopefully other people who are in the same position can make use of it. This is assuming you are installing a GNU/Linux distro on your machine; I can&rsquo;t speak to any of this working with Windows.</em></p>
<h2 id=tldr---youre-already-familiar-with-coreboot-but-just-want-dgpu-support>tl;dr - You&rsquo;re already familiar with coreboot but just want dGPU support<a hidden class=anchor aria-hidden=true href=#tldr---youre-already-familiar-with-coreboot-but-just-want-dgpu-support>#</a></h2>
<p>The current coreboot code for the T440p has the PCI Express Graphics (PEG) device that handles the dGPU disabled. Thanks to <a href=https://github.com/nullenvk/>nullenvk</a>, you can restore dGPU functions by applying <a href=https://github.com/nullenvk/coreboot/commit/aef930dcb6089ef21f00820b2af93654138e1f83>this commit</a>, which adds the
&ldquo;Enable dedicated graphics (experimental)&rdquo; option to nconfig. Enabling this will re-enable the PEG device in your next coreboot build. You need to include the VBIOS for both the iGPU and dGPU. You can extract both using <a href=https://github.com/coderobe/VBiosFinder>VBiosFinder</a>.
If you&rsquo;re building coreboot from master branch, the current SeaBIOS payload will result in a bootloop. Use SeaBIOS 1.15 or TianoCore (UEFI OS only).</p>
<h2 id=the-long-version>The Long Version<a hidden class=anchor aria-hidden=true href=#the-long-version>#</a></h2>
<h3 id=intro>Intro<a hidden class=anchor aria-hidden=true href=#intro>#</a></h3>
<p>The Thinkpad T440p is a 14" laptop released in November 2013 by Lenovo. They&rsquo;re tough, upgradable and plentiful on the used market.
There are <a href=https://octoperf.com/blog/2018/11/07/thinkpad-t440p-buyers-guide/>multiple</a> <a href=https://seiba.gitlab.io/thinkpad-t440p-upgrade-guide/>writeups</a> espousing their virtues
and limitations.</p>
<p>Back in December I managed to get a good deal on a second hand T440p. The listing was sparse and mostly listed the 4GB RAM and 4-core low power i5 CPU, but I could source upgrades for both.
I got it home to find out it also had a locked BIOS and an NVIDIA dedicated GPU. I wasn&rsquo;t counting on either of these but thankfully there neither would be a problem. As of November 2019, The T440p supports Coreboot,
an open source firmware platform. There are multiple good guides that step through how to build (or give you an already built) coreboot and flash the whole thing for the first time.
However, information on getting a dGPU working is scattered and outdated. It seems that, even when coreboot users have the dGPU on-board, they typically opt not to use it. The dGPU adds a lot of battery drain and heat to keep under control. The heatsink and fan
on this unit handle both the CPU and GPU, and if one was focussing on CPU performance thanks to an upgrade, they would likely want to avoid the heat contest with the dGPU.
To make matters more confusing, if one recently followed the instructions to manually build coreboot for themselves and chose to use the current SeaBIOS (1.16) payload, they&rsquo;d get a bootloop.</p>
<p>Given that the dGPU is much higher power draw for questionable performance gains, it might seem somewhat redundant to try and get it going. However in my testing I&rsquo;ve found the GT 730M to play older games at reasonable (720p) framerates.
Additionally, the GT 730M has &lsquo;complete&rsquo; Vulkan support, while the HD 4600 warns that the implementation is incomplete; the only example <em>I</em> have is that the iGPU cannot run Half-Life 2 via Proton/DXVK, but has no problem with the ToGL &lsquo;native&rsquo; Linux port.
The dGPU can do either, which opens up the possibility of running older or lower spec Windows games on the machine.</p>
<h3 id=building-coreboot-with-dgpu-support>Building Coreboot with dGPU Support<a hidden class=anchor aria-hidden=true href=#building-coreboot-with-dgpu-support>#</a></h3>
<p>Here&rsquo;s the stuff that helped me the most:</p>
<ul>
<li><a href=https://github.com/merge/skulls/tree/master/t440p>Skulls Pre-built Coreboot Images for T440p</a> - Follow this guide to get a working, albeit slightly outdated coreboot install with a SeaBIOS 1.15 payload. Requires the least amount of steps for a working install imo.</li>
<li><a href=https://blog.0xcb.dev/lenovo-t440p-coreboot/>Conor Burns Excellent T440p Coreboot Flashing Guide</a> - Following this will get you a working coreboot install with a Tianocore payload, which only supports booting UEFI OSes, however this guide takes you through manually building and flashing coreboot yourself, is <em>fairly</em> recent, and comes with a good base set of config parameters. Highly recommended.</li>
</ul>
<p>These are both excellent, but unfortunately neither will yield a coreboot install with dedicated GPU support, since in coreboot itself the PCIe device that handles the dGPU is disabled by default. This helps iGPU only units, but is crucial for dGPU units to access the dGPU.
Thanks to <a href=https://github.com/nullenvk/>nullenvk</a> figuring this out, there is a <a href=https://github.com/nullenvk/coreboot/commit/aef930dcb6089ef21f00820b2af93654138e1f83>commit</a> that will add the option to re-enable this PEG device in the coreboot configuration.
You can apply this as a patch to a local copy of the coreboot repo. The whole process looks something like this:</p>
<pre tabindex=0><code>git clone https://github.com/coreboot/coreboot
cd coreboot
curl https://github.com/nullenvk/coreboot/commit/aef930dcb6089ef21f00820b2af93654138e1f83.patch | git apply -v
</code></pre><p>This will patch some files in the t440p section of the coreboot source, and then when running make nconfig, you will have the extra dGPU toggle. Thanks nullenvk!</p>
<p>Here&rsquo;s a summary of my steps:</p>
<ol>
<li>Followed <a href=https://blog.0xcb.dev/lenovo-t440p-coreboot/>Conor&rsquo;s guide</a>, up to Configuration section, but used the <a href=https://github.com/coreboot/coreboot>coreboot master branch</a> instead of the suggested branch and did not downgrade gcc.</li>
<li>Applied <a href=https://github.com/nullenvk/coreboot/commit/aef930dcb6089ef21f00820b2af93654138e1f83.patch>nullenvk&rsquo;s changes as a patch to local coreboot repo</a> - see above</li>
<li>Extracted both VBIOS blobs from the t440p-original.rom made during the guide using <a href=https://github.com/coderobe/VBiosFinder>VBiosFinder</a></li>
<li>Continued Conor&rsquo;s guide. During make nconfig, enabled dedicated graphics and added both VBIOS files.</li>
<li>Draw the rest of the fucking owl (build coreboot)</li>
</ol>
<p>At this point you can either split it as per the guide and do the first ever flash, or (in my case, since I already had a skulls image installed) flash coreboot from the OS&mldr; and Voila! The dGPU is&mldr; still not listed in lscpi or dmesg.
The last step you will need to do is build nvramtool and use it to enable the &ldquo;Dual Graphics&rdquo; feature. <em>Then</em> after a reboot, you should have a working dGPU using the nouveau driver. Now you can enjoy the pain of configuring the nvidia proprietary driver
alongside i915/mesa and getting it to meaningfully work and switch on your whim. Have fun! I put some of that down below if you&rsquo;re still looking to punish yourself a little.</p>
<h3 id=optimus-prime>Optimus PRIME<a hidden class=anchor aria-hidden=true href=#optimus-prime>#</a></h3>
<p>You are now working with an <a href=https://www.nvidia.com/en-us/geforce/technologies/optimus/technology/>NVIDIA Optimus</a> environment, the name for their hybrid graphics solution that puts the dGPU behind the iGPU and creates all kinds of cursed power
consumption, tearing, sync, Wayland/X11 issues, etc. This is a hardware-level implementation, so you unfortunately can&rsquo;t magic it away with FOSS.
You are spoilt for many (unsatisfactory) choices when picking a way of handling this. Here&rsquo;s the <a href=https://wiki.archlinux.org/title/NVIDIA_Optimus>Arch Wiki page that covers most of the options</a>.</p>
<p>FWIW I use <a href=https://github.com/geminis3/envycontrol>EnvyControl</a>. This tool will let you switch between pure iGPU with the dGPU disabled, full dGPU, and &ldquo;Hybrid&rdquo; mode, requiring a system reboot between each change.
<a href=https://github.com/geminis3/envycontrol/wiki/Frequently-Asked-Questions#graphics-modes-explained>These all come with caveats</a>, but I think I am happy with switching between iGPU only and Hybrid. This allows me to use Wayland most of the time since the iGPU will handle
the Desktop Environment, passing OGL/Vulkan workloads to the dGPU on demand. Envycontrol will also handle the kernel parameter necessary for getting tear-free sync when the dGPU is running, which typically gets in the way of fully disabling the nvidia GPU
in other solutions.</p>
<p>On an aside, what the fuck is NVIDIA doing with the tearing sync? If you don&rsquo;t use the <code>nvidia-drm.modeset=1</code> parameter when using the dGPU on it&rsquo;s own, you get <em>diagonal</em> tearing. What the hell kinda order are they drawing the framebuffer?</p>
<p>Anyway, some useful variables when operating in hybrid mode:</p>
<ul>
<li><code>__NV_PRIME_RENDER_OFFLOAD=1 __GLX_VENDOR_LIBRARY_NAME=nvidia __VK_LAYER_NV_optimus=NVIDIA_only</code> will enable offload rendering and tell OpenGL and Vulkan programs to use the nvidia driver.
An easy drop in solution is to put all of these variables in a script like below, and throw it in your $PATH somewhere, as per this askubuntu answer: <a href=https://askubuntu.com/a/1368463>https://askubuntu.com/a/1368463</a></li>
</ul>
<pre tabindex=0><code>#!/bin/bash
export __NV_PRIME_RENDER_OFFLOAD=1
export __GLX_VENDOR_LIBRARY_NAME=nvidia
export __VK_LAYER_NV_optimus=NVIDIA_only
export VK_ICD_FILENAMES=/usr/share/vulkan/icd.d/nvidia_icd.json
exec &quot;$@&quot;
</code></pre><ul>
<li>I&rsquo;ve found Vulkan programs seem to correctly select the dGPU on their own since it shows up as Vulkan device 0 in hybrid mode for me. The above <code>__VK_LAYER_NV_optimus=NVIDIA_only</code> parameter should force this regardless.
Most of the Vulkan programs will let you pick the Vulkan device via an argument/config file/menu/etc.</li>
<li>If you are using Proton/DXVK, you can use the parameter <code>DXVK_FILTER_DEVICE_NAME="GeForce GT 730M"</code> to force the dGPU or <code>DXVK_FILTER_DEVICE_NAME="HD Graphics 4600"</code> to force the iGPU.
Device names might need to be changed depending on model, and you can find them using <code>vulkaninfo</code>. <strong>This won&rsquo;t work for native Vulkan games/programs since they don&rsquo;t use DXVK.</strong></li>
</ul>
<h2 id=miscellaneous>Miscellaneous<a hidden class=anchor aria-hidden=true href=#miscellaneous>#</a></h2>
<ul>
<li>Despite what I read online, you <strong>can</strong> use libgfxinit to boot as well as install both VBIOS blobs for the Intel and NVIDIA GPUs.</li>
<li>The last NVIDIA driver the GT 730M supports is nvidia-470. These are available on the AUR as <code>nvidia-470xx-dkms</code>.</li>
<li>If you use <a href=https://github.com/flightlessmango/MangoHud>MangoHud</a>, enable the vulkan_driver option and you will be able to identify which GPU the current software is running on based on which driver is providing Vulkan; &ldquo;470&mldr;&rdquo; for NVIDIA and &ldquo;Mesa&mldr;&rdquo; for Intel.</li>
<li>When using Wayland in hybrid mode, whatever it&rsquo;s enforcing on XWayland causes the dGPU to enforce Vsync even when manually disabled by other means. I can only get an uncapped framerate in 3d workloads on the dGPU by using X11. I might be overlooking something.</li>
<li>Steam Big Picture warns against using the iGPU at 1080p due to the limited (256mb) of assigned RAM -> VRAM. In hybrid mode, you can run steam itself with the above rendering offload commands to get Big Picture to use the dGPU (with it&rsquo;s dedicated 1GB VRAM)
and circumvent this issue.</li>
<li>Steam Remote Play uses VAAPI regardless of which GPU you give it, and results in roughly the same ~14ms latency on either. Tested at 1080p to a desktop machine running Earth Defense Force 5. Very playable. I wouldn&rsquo;t bother offloading remote game streaming to the dGPU.</li>
<li>My specific touchpad stops responding correctly or entirely after suspend. This was fixed for me with the kernel parameter <code>psmouse.synaptics_intertouch=0</code>. YMMV depending on the touchpad make/model.</li>
<li>Under coreboot on the T440p, The SD Card Reader <a href=https://ticket.coreboot.org/issues/297>doesn&rsquo;t work</a>.</li>
</ul>
<p>That&rsquo;s everything for now. I&rsquo;ve tried to play a few older or lower spec games at 720p such as HL2, Portal and ULTRAKILL, all of which ran well enough.
Over the next few weeks I will be trying other software to see if the additional acceleration is worth the time. I was thinking of benchmarking some things to compare using Mangohud, but the logging function appears to fail
to write with certain game names. I may need to check my configuration.</p>
</div>
<footer class=post-footer>
<ul class=post-tags>
</ul>
<nav class=paginav>
<a class=next href=https://crayphish.github.io/posts/hello-world/>
<span class=title>Next »</span>
<br>
<span>welcom 2 my websight</span>
</a>
</nav>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label='share Adventures with the Thinkpad T440p, dGPU and Coreboot in "Mid 2022" on twitter' href="https://twitter.com/intent/tweet/?text=Adventures%20with%20the%20Thinkpad%20T440p%2c%20dGPU%20and%20Coreboot%20in%20%22Mid%202022%22&url=https%3a%2f%2fcrayphish.github.io%2fposts%2ft440p-adventures%2f&hashtags="><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label='share Adventures with the Thinkpad T440p, dGPU and Coreboot in "Mid 2022" on linkedin' href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fcrayphish.github.io%2fposts%2ft440p-adventures%2f&title=Adventures%20with%20the%20Thinkpad%20T440p%2c%20dGPU%20and%20Coreboot%20in%20%22Mid%202022%22&summary=Adventures%20with%20the%20Thinkpad%20T440p%2c%20dGPU%20and%20Coreboot%20in%20%22Mid%202022%22&source=https%3a%2f%2fcrayphish.github.io%2fposts%2ft440p-adventures%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label='share Adventures with the Thinkpad T440p, dGPU and Coreboot in "Mid 2022" on reddit' href="https://reddit.com/submit?url=https%3a%2f%2fcrayphish.github.io%2fposts%2ft440p-adventures%2f&title=Adventures%20with%20the%20Thinkpad%20T440p%2c%20dGPU%20and%20Coreboot%20in%20%22Mid%202022%22"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label='share Adventures with the Thinkpad T440p, dGPU and Coreboot in "Mid 2022" on facebook' href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fcrayphish.github.io%2fposts%2ft440p-adventures%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label='share Adventures with the Thinkpad T440p, dGPU and Coreboot in "Mid 2022" on whatsapp' href="https://api.whatsapp.com/send?text=Adventures%20with%20the%20Thinkpad%20T440p%2c%20dGPU%20and%20Coreboot%20in%20%22Mid%202022%22%20-%20https%3a%2f%2fcrayphish.github.io%2fposts%2ft440p-adventures%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg>
</a>
<a target=_blank rel="noopener noreferrer" aria-label='share Adventures with the Thinkpad T440p, dGPU and Coreboot in "Mid 2022" on telegram' href="https://telegram.me/share/url?text=Adventures%20with%20the%20Thinkpad%20T440p%2c%20dGPU%20and%20Coreboot%20in%20%22Mid%202022%22&url=https%3a%2f%2fcrayphish.github.io%2fposts%2ft440p-adventures%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://crayphish.github.io/>Crayblog</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerHTML='copy';function d(){a.innerHTML='copied!',setTimeout(()=>{a.innerHTML='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>